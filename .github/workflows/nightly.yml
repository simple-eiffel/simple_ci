name: Nightly Health Check - All Libraries

on:
  schedule:
    # Run at 2 AM EST (7 AM UTC) every day
    # Note: During EDT (daylight saving), this is 3 AM local time
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      libraries:
        description: 'Space-separated list of libraries to test (empty = all)'
        required: false
        default: ''
      send_email:
        description: 'Send email report even on success'
        required: false
        type: boolean
        default: true

env:
  ISE_EIFFEL: /usr/local/eiffel
  ISE_PLATFORM: linux-x86-64
  ISE_LIBRARY: /usr/local/eiffel
  SIMPLE_EIFFEL: /opt/simple_eiffel

jobs:
  # 3 parallel test jobs - each tests a tier of libraries
  test-tier:
    runs-on: [self-hosted, eiffel]
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        tier: [1, 2, 3]
        include:
          # Tier 1: Foundations (no deps on other simple_* with C code)
          - tier: 1
            libraries: "simple_testing simple_base64 simple_datetime simple_uuid simple_hash simple_logger simple_file simple_toml simple_codec simple_csv simple_decimal simple_fraction simple_template simple_cache simple_validation simple_regex simple_markdown"
          # Tier 2: C code libraries + their dependents
          - tier: 2
            libraries: "simple_env simple_mmap simple_system simple_watcher simple_process simple_json simple_xml simple_yaml simple_http simple_sql simple_jwt simple_websocket simple_smtp simple_rate_limiter"
          # Tier 3: Full stack (depend on multiple tiers)
          - tier: 3
            libraries: "simple_pdf simple_web simple_k8s simple_lsp simple_graph simple_math simple_mq simple_telemetry simple_scheduler simple_grpc"

    steps:
    - name: Install system dependencies
      run: |
        # FastCGI library required by EWF web framework (simple_web)
        sudo apt-get update -qq
        sudo apt-get install -y libfcgi-dev

    - name: Verify EiffelStudio
      run: |
        export PATH="$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/bin:$PATH"
        echo "=== Tier ${{ matrix.tier }} - EiffelStudio Version ==="
        ec -version

    - name: Setup dependencies
      run: |
        mkdir -p $SIMPLE_EIFFEL
        cd $SIMPLE_EIFFEL

        # All libraries including eiffel_sqlite_2025
        DEPS="eiffel_sqlite_2025 simple_ai_client simple_alpine simple_archive simple_base64 simple_cache simple_ci simple_cli simple_clipboard simple_codec simple_compression simple_config simple_console simple_cors simple_csv simple_datetime simple_decimal simple_docker simple_eiffel_parser simple_encryption simple_env simple_file simple_fraction simple_graph simple_grpc simple_hash simple_htmx simple_html simple_http simple_i18n simple_ipc simple_json simple_jwt simple_k8s simple_logger simple_lsp simple_markdown simple_math simple_mmap simple_mongo simple_mq simple_pdf simple_process simple_randomizer simple_rate_limiter simple_regex simple_scheduler simple_setup simple_smtp simple_sql simple_system simple_telemetry simple_template simple_testing simple_toml simple_toon simple_ucf simple_uuid simple_validation simple_watcher simple_web simple_websocket simple_xml simple_yaml"

        echo "=== Cloning/Updating all libraries ==="
        for lib in $DEPS; do
          if [ -d "$lib" ]; then
            echo "Updating $lib..."
            cd "$lib" && git pull --ff-only 2>/dev/null || git fetch origin && git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || true
            cd $SIMPLE_EIFFEL
          else
            echo "Cloning $lib..."
            git clone --depth 1 https://github.com/simple-eiffel/$lib.git 2>/dev/null || true
          fi
        done

        echo ""
        echo "Libraries available: $(ls -d */ 2>/dev/null | wc -l)"

    - name: Pre-compile C libraries
      run: |
        cd $SIMPLE_EIFFEL
        # Libraries with inline C code that need .o files for Linux
        for lib in simple_env simple_process simple_mmap simple_system simple_watcher eiffel_sqlite_2025; do
          if [ -d "$lib/Clib" ]; then
            echo "=== Compiling C code for $lib ==="
            cd "$lib/Clib"
            rm -f *.o
            for cfile in *.c; do
              if [ -f "$cfile" ]; then
                if [ "$lib" = "eiffel_sqlite_2025" ]; then
                  gcc -c -fPIC -I$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/include "$cfile" -o "${cfile%.c}.o"
                else
                  gcc -c -fPIC "$cfile" -o "${cfile%.c}.o"
                fi
              fi
            done
            ls -la *.o 2>/dev/null || echo "  Warning: No .o files generated"
            cd $SIMPLE_EIFFEL
          fi
        done
        echo "=== C library compilation complete ==="

    - name: Run tier ${{ matrix.tier }} tests
      id: tests
      run: |
        export PATH="$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/bin:$PATH"
        cd $SIMPLE_EIFFEL

        # Libraries to test for this tier
        if [ -n "${{ github.event.inputs.libraries }}" ]; then
          TEST_LIBS="${{ github.event.inputs.libraries }}"
        else
          TEST_LIBS="${{ matrix.libraries }}"
        fi

        echo "=== Tier ${{ matrix.tier }}: Testing libraries: $TEST_LIBS ==="
        echo ""

        PASSED=0
        FAILED=0
        SKIPPED=0
        PASSED_LIBS=""
        FAILED_LIBS=""
        SKIPPED_LIBS=""

        # Create tier-specific report
        REPORT_FILE="/tmp/health_report_tier${{ matrix.tier }}.md"
        echo "## Tier ${{ matrix.tier }} Results" > $REPORT_FILE
        echo "" >> $REPORT_FILE
        echo "| Library | Status | Details |" >> $REPORT_FILE
        echo "|---------|--------|---------|" >> $REPORT_FILE

        for lib in $TEST_LIBS; do
          echo ""
          echo "========================================"
          echo "Testing: $lib"
          echo "========================================"

          if [ ! -d "$lib" ]; then
            echo "SKIP: $lib not found"
            SKIPPED=$((SKIPPED + 1))
            SKIPPED_LIBS="$SKIPPED_LIBS $lib"
            echo "| $lib | ⏭️ SKIP | Not found |" >> $REPORT_FILE
            continue
          fi

          cd "$lib"

          # Find ECF file
          ECF_FILE=$(find . -maxdepth 1 -name "*.ecf" | head -1)
          if [ -z "$ECF_FILE" ]; then
            echo "SKIP: No ECF file found"
            SKIPPED=$((SKIPPED + 1))
            SKIPPED_LIBS="$SKIPPED_LIBS $lib"
            echo "| $lib | ⏭️ SKIP | No ECF file |" >> $REPORT_FILE
            cd $SIMPLE_EIFFEL
            continue
          fi

          # Find test target
          TEST_TARGET=$(grep -o 'target name="[^"]*_tests"' "$ECF_FILE" | sed 's/target name="//;s/"$//' | head -1)
          if [ -z "$TEST_TARGET" ]; then
            TEST_TARGET=$(grep -o 'target name="[^"]*"' "$ECF_FILE" | sed 's/target name="//;s/"$//' | head -1)
          fi

          echo "ECF: $ECF_FILE, Target: $TEST_TARGET"

          # Clean and compile (Eiffel only first)
          rm -rf EIFGENs
          if ec -batch -config "$ECF_FILE" -target "$TEST_TARGET" -freeze 2>&1 | tail -5; then
            # Fix Makefile paths
            if [ -d "EIFGENs" ]; then
              cd EIFGENs/*/W_code 2>/dev/null || cd $SIMPLE_EIFFEL/$lib

              # Fix $SIMPLE_EIFFEL paths in all Makefiles
              for f in Makefile Makefile.SH; do
                if [ -f "$f" ]; then
                  sed -i "s|\\\$SIMPLE_EIFFEL|$SIMPLE_EIFFEL|g" "$f" 2>/dev/null || true
                  sed -i "s|\$(SIMPLE_EIFFEL)|$SIMPLE_EIFFEL|g" "$f" 2>/dev/null || true
                fi
              done
              for mkfile in C*/Makefile; do
                if [ -f "$mkfile" ]; then
                  sed -i "s|\\\$SIMPLE_EIFFEL|$SIMPLE_EIFFEL|g" "$mkfile" 2>/dev/null || true
                  sed -i "s|\$(SIMPLE_EIFFEL)|$SIMPLE_EIFFEL|g" "$mkfile" 2>/dev/null || true
                fi
              done

              # Run C compilation
              export CFLAGS="-I$SIMPLE_EIFFEL/eiffel_sqlite_2025/Clib"
              if finish_freezing 2>&1 | tail -3; then
                cd $SIMPLE_EIFFEL/$lib

                # Find and run executable
                EXECUTABLE=$(find EIFGENs -type f -executable 2>/dev/null | grep -v "\.o$" | head -1)
                if [ -n "$EXECUTABLE" ]; then
                  echo "Running: $EXECUTABLE"
                  if timeout 120 "$EXECUTABLE" 2>&1; then
                    echo "PASS: $lib"
                    PASSED=$((PASSED + 1))
                    PASSED_LIBS="$PASSED_LIBS $lib"
                    echo "| $lib | ✅ PASS | Tests passed |" >> $REPORT_FILE
                  else
                    echo "FAIL: $lib (test execution failed)"
                    FAILED=$((FAILED + 1))
                    FAILED_LIBS="$FAILED_LIBS $lib"
                    echo "| $lib | ❌ FAIL | Test execution failed |" >> $REPORT_FILE
                  fi
                else
                  echo "FAIL: $lib (no executable)"
                  FAILED=$((FAILED + 1))
                  FAILED_LIBS="$FAILED_LIBS $lib"
                  echo "| $lib | ❌ FAIL | No executable generated |" >> $REPORT_FILE
                fi
              else
                echo "FAIL: $lib (C compilation failed)"
                FAILED=$((FAILED + 1))
                FAILED_LIBS="$FAILED_LIBS $lib"
                echo "| $lib | ❌ FAIL | C compilation failed |" >> $REPORT_FILE
              fi
            else
              echo "FAIL: $lib (no EIFGENs)"
              FAILED=$((FAILED + 1))
              FAILED_LIBS="$FAILED_LIBS $lib"
              echo "| $lib | ❌ FAIL | Eiffel compilation failed |" >> $REPORT_FILE
            fi
          else
            echo "FAIL: $lib (Eiffel compilation failed)"
            FAILED=$((FAILED + 1))
            FAILED_LIBS="$FAILED_LIBS $lib"
            echo "| $lib | ❌ FAIL | Eiffel compilation failed |" >> $REPORT_FILE
          fi

          cd $SIMPLE_EIFFEL
        done

        # Tier summary
        echo "" >> $REPORT_FILE
        echo "**Tier ${{ matrix.tier }} Summary:** $PASSED passed, $FAILED failed, $SKIPPED skipped" >> $REPORT_FILE

        # Console summary
        echo ""
        echo "========================================"
        echo "=== TIER ${{ matrix.tier }} SUMMARY ==="
        echo "========================================"
        echo "Passed: $PASSED"
        echo "Failed: $FAILED"
        echo "Skipped: $SKIPPED"
        if [ -n "$FAILED_LIBS" ]; then
          echo "Failed libraries:$FAILED_LIBS"
        fi

        # Set outputs
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        echo "failed_libs=$FAILED_LIBS" >> $GITHUB_OUTPUT

      timeout-minutes: 60

    - name: Upload tier report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-tier-${{ matrix.tier }}
        path: /tmp/health_report_tier${{ matrix.tier }}.md
        retention-days: 30

  # Aggregate results from all tiers
  report:
    needs: test-tier
    runs-on: [self-hosted, eiffel]
    if: always()

    steps:
    - name: Download all tier reports
      uses: actions/download-artifact@v4
      with:
        pattern: health-report-tier-*
        path: /tmp/reports
        merge-multiple: true

    - name: Generate combined report
      id: combined
      run: |
        echo "# Simple Eiffel Nightly Health Report" > /tmp/health_report.md
        echo "" >> /tmp/health_report.md
        echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> /tmp/health_report.md
        echo "**Triggered by:** ${{ github.event_name }}" >> /tmp/health_report.md
        echo "**Parallel Jobs:** 3 tiers" >> /tmp/health_report.md
        echo "" >> /tmp/health_report.md

        # Combine tier reports
        for tier in 1 2 3; do
          if [ -f "/tmp/reports/health_report_tier${tier}.md" ]; then
            cat "/tmp/reports/health_report_tier${tier}.md" >> /tmp/health_report.md
            echo "" >> /tmp/health_report.md
          fi
        done

        echo "---" >> /tmp/health_report.md
        echo "*Report generated by Simple Eiffel CI (3 parallel runners)*" >> /tmp/health_report.md

        # Calculate totals from job outputs
        TOTAL_PASSED=0
        TOTAL_FAILED=0
        TOTAL_SKIPPED=0

        # Add up from matrix outputs (workaround: parse from reports)
        TOTAL_PASSED=$(grep -o '[0-9]* passed' /tmp/health_report.md | awk '{sum += $1} END {print sum}')
        TOTAL_FAILED=$(grep -o '[0-9]* failed' /tmp/health_report.md | awk '{sum += $1} END {print sum}')
        TOTAL_SKIPPED=$(grep -o '[0-9]* skipped' /tmp/health_report.md | awk '{sum += $1} END {print sum}')

        echo "" >> /tmp/health_report.md
        echo "## Overall Summary" >> /tmp/health_report.md
        echo "- **Total Passed:** $TOTAL_PASSED" >> /tmp/health_report.md
        echo "- **Total Failed:** $TOTAL_FAILED" >> /tmp/health_report.md
        echo "- **Total Skipped:** $TOTAL_SKIPPED" >> /tmp/health_report.md

        echo "passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT
        echo "failed=$TOTAL_FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$TOTAL_SKIPPED" >> $GITHUB_OUTPUT

        if [ "$TOTAL_FAILED" -gt 0 ]; then
          echo "status=FAILED" >> $GITHUB_OUTPUT
        else
          echo "status=PASSED" >> $GITHUB_OUTPUT
        fi

    - name: Upload combined report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-combined
        path: /tmp/health_report.md
        retention-days: 30

    - name: Create GitHub Job Summary
      run: |
        cat /tmp/health_report.md >> $GITHUB_STEP_SUMMARY

    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Simple Eiffel Nightly: ${{ steps.combined.outputs.status }} - ${{ steps.combined.outputs.passed }} passed, ${{ steps.combined.outputs.failed }} failed"
        to: ${{ secrets.EMAIL_TO }}
        from: Simple Eiffel CI <${{ secrets.EMAIL_USERNAME }}>
        body: |
          Simple Eiffel Nightly Health Check Report
          ==========================================

          Status: ${{ steps.combined.outputs.status }}

          Results (3 parallel tiers):
          - Passed: ${{ steps.combined.outputs.passed }}
          - Failed: ${{ steps.combined.outputs.failed }}
          - Skipped: ${{ steps.combined.outputs.skipped }}

          View full report: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ---
          This is an automated message from Simple Eiffel CI.
        content_type: text/plain
      continue-on-error: true

    - name: Fail if tests failed
      if: steps.combined.outputs.failed != '0' && steps.combined.outputs.failed != ''
      run: |
        echo "::error::${{ steps.combined.outputs.failed }} libraries failed nightly tests"
        exit 1
